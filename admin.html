<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat com Login Firebase + Admin</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin:0; padding:0;
    background:#f4f7f9;
  }
  #loginSection, #chatSection, #adminSection {
    max-width: 900px;
    margin: 20px auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.1);
    padding: 20px;
  }
  #loginSection {text-align:center;}
  button {
    background:#1abc9c;
    border:none;
    color:white;
    padding:10px 18px;
    border-radius:5px;
    cursor:pointer;
    font-weight:bold;
    margin-top:10px;
  }
  button:hover {background:#16a085;}
  #userInfo {
    margin-top:15px;
  }
  #userInfo img {
    width: 70px; height: 70px;
    border-radius: 50%;
    vertical-align: middle;
    margin-right: 10px;
  }
  #chatMessages {
    height: 400px;
    border: 1px solid #ddd;
    overflow-y: auto;
    padding: 10px;
    background: #fefefe;
    margin-bottom: 10px;
    border-radius: 6px;
  }
  .msg {
    margin-bottom: 12px;
    display: flex;
    align-items: center;
  }
  .msg .fotoUser {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 8px;
    object-fit: cover;
  }
  .msg .msgContent {
    background: #1abc9c;
    color: white;
    padding: 8px 12px;
    border-radius: 12px;
    max-width: 75%;
    word-wrap: break-word;
  }
  .msg.me .msgContent {
    background: #16a085;
  }
  #inputMsg {
    width: calc(100% - 100px);
    padding: 8px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  #btnSendMsg {
    width: 80px;
  }
  #btnLogout {
    background: #e74c3c;
    margin-left: 10px;
  }
  /* Admin Collapsible */
  #adminToggle {
    background:#2980b9;
    margin:20px auto;
    display:block;
    color:white;
    font-weight:bold;
    border-radius:5px;
    padding:10px 0;
    width: 150px;
    cursor:pointer;
  }
  #adminSection {
    display:none;
  }
  /* Admin table style */
  table {
    width: 100%;
    border-collapse: collapse;
    margin-bottom: 20px;
  }
  th, td {
    border:1px solid #ddd;
    padding: 8px;
    text-align: center;
  }
  th {
    background: #1abc9c;
    color: white;
  }
  input[type="text"], input[type="file"] {
    width: 100%;
    box-sizing: border-box;
    padding: 5px;
  }
  .fotoUserAdmin {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

</head>
<body>

<!-- Login -->
<section id="loginSection">
  <h1>Entrar no Chat</h1>
  <button id="btnLoginGoogle">Entrar com Google</button>
  <button id="btnLogout" style="display:none;">Sair</button>

  <div id="userInfo" style="display:none;">
    <img id="userFoto" alt="Foto do usuário"/>
    <span id="userNome"></span>
  </div>
</section>

<!-- Chat -->
<section id="chatSection" style="display:none;">
  <h2>Chat</h2>
  <div id="chatMessages"></div>
  <input id="inputMsg" type="text" placeholder="Digite sua mensagem..." />
  <button id="btnSendMsg">Enviar</button>
</section>

<!-- Botão para mostrar/ocultar admin -->
<button id="adminToggle">Mostrar Admin</button>

<!-- Admin -->
<section id="adminSection">

  <h2>Painel Admin</h2>

  <section id="usuariosSection">
    <h3>Usuários</h3>
    <table id="tabelaUsuarios">
      <thead>
        <tr>
          <th>Foto</th>
          <th>UID</th>
          <th>Nome</th>
          <th>Banir/Desbanir</th>
          <th>Alterar Foto URL</th>
          <th>Alterar Nome</th>
          <th>Upload Nova Foto</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="7">Carregando usuários...</td></tr>
      </tbody>
    </table>
  </section>

  <section id="gruposSection">
    <h3>Grupos</h3>
    <table id="tabelaGrupos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome do Grupo</th>
          <th>Alterar Nome</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="3">Carregando grupos...</td></tr>
      </tbody>
    </table>
  </section>

  <section id="solicitacoesSection">
    <h3>Solicitações de Novos Grupos</h3>
    <table id="tabelaSolicitacoes">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome Solicitado</th>
          <th>Solicitante (UID)</th>
          <th>Aprovar</th>
          <th>Rejeitar</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5">Carregando solicitações...</td></tr>
      </tbody>
    </table>
  </section>

</section>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBHIc2E4XwRO5FXo4uHlTQVRArOis73MjE",
    authDomain: "projeto-deus-yato-928-sk.firebaseapp.com",
    databaseURL: "https://projeto-deus-yato-928-sk-default-rtdb.firebaseio.com",
    projectId: "projeto-deus-yato-928-sk",
    storageBucket: "projeto-deus-yato-928-sk.appspot.com",
    messagingSenderId: "790408726854",
    appId: "1:790408726854:android:e2f0de7b7d5dba96b0fd47"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // Elementos
  const btnLoginGoogle = document.getElementById('btnLoginGoogle');
  const btnLogout = document.getElementById('btnLogout');
  const userInfo = document.getElementById('userInfo');
  const userFoto = document.getElementById('userFoto');
  const userNome = document.getElementById('userNome');

  const loginSection = document.getElementById('loginSection');
  const chatSection = document.getElementById('chatSection');

  const chatMessages = document.getElementById('chatMessages');
  const inputMsg = document.getElementById('inputMsg');
  const btnSendMsg = document.getElementById('btnSendMsg');

  const adminToggle = document.getElementById('adminToggle');
  const adminSection = document.getElementById('adminSection');

  // Login Google
  btnLoginGoogle.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e => alert('Erro no login: '+e.message));
  };

  btnLogout.onclick = () => {
    auth.signOut();
  };

  // Controla exibição admin
  adminToggle.onclick = () => {
    if(adminSection.style.display === 'none'){
      adminSection.style.display = 'block';
      adminToggle.textContent = 'Ocultar Admin';
    } else {
      adminSection.style.display = 'none';
      adminToggle.textContent = 'Mostrar Admin';
    }
  };

  // Ao mudar usuário logado
  auth.onAuthStateChanged(user => {
    if(user){
      if(user.emailVerified === false) {
        alert('Por favor, verifique seu email para continuar.');
        auth.signOut();
        return;
      }

      // Mostra dados
      loginSection.style.display = 'none';
      chatSection.style.display = 'block';
      btnLogout.style.display = 'inline-block';
      userInfo.style.display = 'inline-flex';

      userFoto.src = user.photoURL || 'https://via.placeholder.com/70';
      userNome.textContent = user.displayName || user.email || 'Usuário';

      // Cria no DB se não existir
      db.ref('usuarios/' + user.uid).once('value').then(snap => {
        if(!snap.exists()){
          db.ref('usuarios/' + user.uid).set({
            nome: user.displayName || '',
            email: user.email || '',
            fotoPerfil: user.photoURL || '',
            banido: false
          });
        }
      });

      // Carrega chat
      carregarMensagens();

      // Carrega admin só pra quem for admin (pode ajustar isso)
      carregarUsuarios();
      carregarGrupos();
      carregarSolicitacoes();

    } else {
      loginSection.style.display = 'block';
      chatSection.style.display = 'none';
      btnLogout.style.display = 'none';
      userInfo.style.display = 'none';
      chatMessages.innerHTML = '';
      tabelaUsuariosBody.innerHTML = '<tr><td colspan="7">Faça login para ver usuários</td></tr>';
      tabelaGruposBody.innerHTML = '<tr><td colspan="3">Faça login para ver grupos</td></tr>';
      tabelaSolicitacoesBody.innerHTML = '<tr><td colspan="5">Faça login para ver solicitações</td></tr>';
    }
  });

  // Enviar mensagem
  btnSendMsg.onclick = () => {
    enviarMensagem();
  };
  inputMsg.addEventListener('keydown', e => {
    if(e.key === 'Enter') enviarMensagem();
  });

  function enviarMensagem(){
    const texto = inputMsg.value.trim();
    if(texto === '') return;

    const user = auth.currentUser;
    if(!user) return alert('Faça login para enviar mensagens');

    // Verifica se banido
    db.ref('usuarios/' + user.uid).once('value').then(snap => {
      if(snap.exists() && snap.val().banido){
        alert('Você está banido e não pode enviar mensagens.');
        return;
      }

      // Salva mensagem
      const msgRef = db.ref('mensagens').push();
      msgRef.set({
        uid: user.uid,
        nome: user.displayName || '',
        fotoPerfil: user.photoURL || '',
        texto: texto,
        timestamp: Date.now()
      });
      inputMsg.value = '';
    });
  }

  // Mostrar mensagens
  function carregarMensagens(){
    db.ref('mensagens').limitToLast(50).on('value', snapshot => {
      const msgs = snapshot.val() || {};
      chatMessages.innerHTML = '';
      for(const key in msgs){
        const m = msgs[key];
        const div = document.createElement('div');
        div.classList.add('msg');
        if(auth.currentUser && auth.currentUser.uid === m.uid) div.classList.add('me');

        div.innerHTML = `
          <img src="${m.fotoPerfil || 'https://via.placeholder.com/40'}" class="fotoUser" />
          <div class="msgContent">${escapeHtml(m.texto)}</div>
        `;
        chatMessages.appendChild(div);
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }

  // Escape HTML para segurança básica
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.innerText = text;
    return div.innerHTML;
  }

  /* ------------------ Admin --------------------- */

  const tabelaUsuariosBody = document.querySelector('#tabelaUsuarios tbody');
  const tabelaGruposBody = document.querySelector('#tabelaGrupos tbody');
  const tabelaSolicitacoesBody = document.querySelector('#tabelaSolicitacoes tbody');

  // Carrega usuários
  function carregarUsuarios() {
    db.ref('usuarios').on('value', snapshot => {
      const users = snapshot.val() || {};
      tabelaUsuariosBody.innerHTML = '';
      if(Object.keys(users).length === 0){
        tabelaUsuariosBody.innerHTML = '<tr><td colspan="7">Nenhum usuário encontrado.</td></tr>';
        return;
      }

      for (const uid in users) {
        const user = users[uid];
        const banido = user.banido || false;

        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td><img src="${user.fotoPerfil || 'https://via.placeholder.com/40'}" class="fotoUserAdmin" /></td>
          <td>${uid}</td>
          <td><input type="text" value="${user.nome || ''}" data-uid="${uid}" class="nomeUsuarioInput" /></td>
          <td><button data-uid="${uid}" class="btnBanir">${banido ? 'Desbanir' : 'Banir'}</button></td>
          <td><input type="text" value="${user.fotoPerfil || ''}" data-uid="${uid}" class="fotoUsuarioInput" /></td>
          <td><button data-uid="${uid}" class="btnAlterar">Alterar</button></td>
          <td>
            <input type="file" accept="image/*" data-uid="${uid}" class="uploadFotoInput" />
            <button data-uid="${uid}" class="btnUploadFoto">Enviar Foto</button>
          </td>
        `;

        tabelaUsuariosBody.appendChild(tr);
      }

      // Botões banir/desbanir
      document.querySelectorAll('.btnBanir').forEach(btn => {
        btn.onclick = e => {
          const uid = e.target.dataset.uid;
          const userRef = db.ref('usuarios/' + uid);
          userRef.once('value').then(snap => {
            const data = snap.val() || {};
            const novoStatus = !(data.banido || false);
            userRef.update({ banido: novoStatus });
          });
        };
      });

      // Botão alterar nome e foto via input
      document.querySelectorAll('.btnAlterar').forEach(btn => {
        btn.onclick = e => {
          const uid = e.target.dataset.uid;
          const tr = e.target.closest('tr');
          const novoNome = tr.querySelector('.nomeUsuarioInput').value.trim();
          const novaFoto = tr.querySelector('.fotoUsuarioInput').value.trim();

          if (novoNome === '') {
            alert('Nome não pode ser vazio');
            return;
          }

          db.ref('usuarios/' + uid).update({
            nome: novoNome,
            fotoPerfil: novaFoto
          }).then(() => {
            alert('Dados atualizados');
          });
        };
      });

      // Upload foto para Storage e atualizar DB
      document.querySelectorAll('.btnUploadFoto').forEach(btn => {
        btn.onclick = async e => {
          const uid = e.target.dataset.uid;
          const tr = e.target.closest('tr');
          const inputFile = tr.querySelector('.uploadFotoInput');
          const file = inputFile.files[0];
          if (!file) {
            alert('Selecione uma imagem para enviar');
            return;
          }

          try {
            const storageRef = storage.ref(`usuariosFotos/${uid}_${Date.now()}.jpg`);
            const snapshot = await storageRef.put(file);
            const url = await snapshot.ref.getDownloadURL();

            await db.ref(`usuarios/${uid}`).update({ fotoPerfil: url });
            alert('Foto atualizada com sucesso!');

            inputFile.value = '';
          } catch (error) {
            alert('Erro ao enviar imagem: ' + error.message);
          }
        };
      });

    });
  }

  // Carrega grupos
  function carregarGrupos() {
    db.ref('grupos').on('value', snapshot => {
      const grupos = snapshot.val() || {};
      tabelaGruposBody.innerHTML = '';
      if(Object.keys(grupos).length === 0){
        tabelaGruposBody.innerHTML = '<tr><td colspan="3">Nenhum grupo encontrado.</td></tr>';
        return;
      }

      for (const grupoId in grupos) {
        const grupo = grupos[grupoId];
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${grupoId}</td>
          <td><input type="text" value="${grupo.nome || ''}" data-id="${grupoId}" class="nomeGrupoInput" /></td>
          <td><button data-id="${grupoId}" class="btnAlterarGrupo">Alterar Nome</button></td>
        `;

        tabelaGruposBody.appendChild(tr);
      }

      // Alterar nome grupo
      document.querySelectorAll('.btnAlterarGrupo').forEach(btn => {
        btn.onclick = e => {
          const grupoId = e.target.dataset.id;
          const tr = e.target.closest('tr');
          const novoNome = tr.querySelector('.nomeGrupoInput').value.trim();

          if (novoNome === '') {
            alert('Nome do grupo não pode ser vazio');
            return;
          }

          db.ref('grupos/' + grupoId).update({ nome: novoNome })
            .then(() => alert('Nome do grupo atualizado'));
        };
      });

    });
  }

  // Carrega solicitações grupos
  function carregarSolicitacoes() {
    db.ref('solicitacoesGrupos').on('value', snapshot => {
      const solicitacoes = snapshot.val() || {};
      tabelaSolicitacoesBody.innerHTML = '';
      if(Object.keys(solicitacoes).length === 0){
        tabelaSolicitacoesBody.innerHTML = '<tr><td colspan="5">Nenhuma solicitação pendente.</td></tr>';
        return;
      }

      for (const id in solicitacoes) {
        const s = solicitacoes[id];
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${id}</td>
          <td>${s.nome}</td>
          <td>${s.uidSolicitante}</td>
          <td><button data-id="${id}" class="btnAprovar">Aprovar</button></td>
          <td><button data-id="${id}" class="btnRejeitar">Rejeitar</button></td>
        `;

        tabelaSolicitacoesBody.appendChild(tr);
      }

      // Aprovar solicitação
      document.querySelectorAll('.btnAprovar').forEach(btn => {
        btn.onclick = e => {
          const id = e.target.dataset.id;
          const solicitacaoRef = db.ref('solicitacoesGrupos/' + id);

          solicitacaoRef.once('value').then(snap => {
            const dados = snap.val();
            if(!dados) return alert('Solicitação não encontrada');

            // Criar novo grupo
            const novoGrupoRef = db.ref('grupos').push();
            novoGrupoRef.set({
              nome: dados.nome
            }).then(() => {
              // Remover solicitação
              solicitacaoRef.remove();
              alert('Grupo criado e solicitação removida');
            });
          });
        };
      });

      // Rejeitar solicitação
      document.querySelectorAll('.btnRejeitar').forEach(btn => {
        btn.onclick = e => {
          const id = e.target.dataset.id;
          db.ref('solicitacoesGrupos/' + id).remove().then(() => {
            alert('Solicitação rejeitada e removida');
          });
        };
      });

    });
  }

</script>

</body>
</html>
