<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Painel Admin - Chat Firebase</title>

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f9f9f9;
    margin: 0; padding: 0;
  }
  h1 {
    background: #34495e;
    color: white;
    margin: 0;
    padding: 20px;
    text-align: center;
  }
  #container {
    max-width: 1000px;
    margin: 20px auto;
    background: white;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  section {
    margin-bottom: 40px;
  }
  h2 {
    border-bottom: 2px solid #1abc9c;
    padding-bottom: 5px;
    color: #1abc9c;
  }
  table {
    width: 100%;
    border-collapse: collapse;
  }
  table, th, td {
    border: 1px solid #ddd;
  }
  th, td {
    padding: 10px;
    text-align: center;
    vertical-align: middle;
  }
  th {
    background: #1abc9c;
    color: white;
  }
  button {
    cursor: pointer;
    border: none;
    background: #1abc9c;
    color: white;
    padding: 6px 12px;
    border-radius: 5px;
    transition: background 0.3s;
  }
  button:hover {
    background: #16a085;
  }
  input[type="text"] {
    width: 100%;
    padding: 6px;
    box-sizing: border-box;
  }
  img.fotoUser {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
  }
  input.uploadFotoInput {
    margin-top: 6px;
    width: 100%;
  }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

</head>
<body>

<h1>Painel Admin</h1>
<div id="container">

  <section id="usuariosSection">
    <h2>Usuários</h2>
    <table id="tabelaUsuarios">
      <thead>
        <tr>
          <th>Foto</th>
          <th>UID</th>
          <th>Nome</th>
          <th>Banir/Desbanir</th>
          <th>Alterar Foto URL</th>
          <th>Alterar Nome</th>
          <th>Upload Nova Foto</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="7">Carregando usuários...</td></tr>
      </tbody>
    </table>
  </section>

  <section id="gruposSection">
    <h2>Grupos</h2>
    <table id="tabelaGrupos">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome do Grupo</th>
          <th>Alterar Nome</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="3">Carregando grupos...</td></tr>
      </tbody>
    </table>
  </section>

  <section id="solicitacoesSection">
    <h2>Solicitações de Novos Grupos</h2>
    <table id="tabelaSolicitacoes">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nome Solicitado</th>
          <th>Solicitante (UID)</th>
          <th>Aprovar</th>
          <th>Rejeitar</th>
        </tr>
      </thead>
      <tbody>
        <tr><td colspan="5">Carregando solicitações...</td></tr>
      </tbody>
    </table>
  </section>

</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBHIc2E4XwRO5FXo4uHlTQVRArOis73MjE",
    authDomain: "projeto-deus-yato-928-sk.firebaseapp.com",
    databaseURL: "https://projeto-deus-yato-928-sk-default-rtdb.firebaseio.com",
    projectId: "projeto-deus-yato-928-sk",
    storageBucket: "projeto-deus-yato-928-sk.appspot.com",
    messagingSenderId: "790408726854",
    appId: "1:790408726854:android:e2f0de7b7d5dba96b0fd47"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();
  const storage = firebase.storage();

  const tabelaUsuariosBody = document.querySelector('#tabelaUsuarios tbody');
  const tabelaGruposBody = document.querySelector('#tabelaGrupos tbody');
  const tabelaSolicitacoesBody = document.querySelector('#tabelaSolicitacoes tbody');

  // Carrega usuários
  function carregarUsuarios() {
    db.ref('usuarios').on('value', snapshot => {
      const users = snapshot.val() || {};
      tabelaUsuariosBody.innerHTML = '';
      if(Object.keys(users).length === 0){
        tabelaUsuariosBody.innerHTML = '<tr><td colspan="7">Nenhum usuário encontrado.</td></tr>';
        return;
      }

      for (const uid in users) {
        const user = users[uid];
        const banido = user.banido || false;

        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>
            <img src="${user.fotoPerfil || 'https://via.placeholder.com/50'}" class="fotoUser" />
          </td>
          <td>${uid}</td>
          <td><input type="text" value="${user.nome || ''}" data-uid="${uid}" class="nomeUsuarioInput" /></td>
          <td><button data-uid="${uid}" class="btnBanir">${banido ? 'Desbanir' : 'Banir'}</button></td>
          <td><input type="text" value="${user.fotoPerfil || ''}" data-uid="${uid}" class="fotoUsuarioInput" /></td>
          <td><button data-uid="${uid}" class="btnAlterar">Alterar</button></td>
          <td>
            <input type="file" accept="image/*" data-uid="${uid}" class="uploadFotoInput" />
            <button data-uid="${uid}" class="btnUploadFoto">Enviar Foto</button>
          </td>
        `;

        tabelaUsuariosBody.appendChild(tr);
      }

      // Eventos dos botões banir/desbanir
      document.querySelectorAll('.btnBanir').forEach(btn => {
        btn.onclick = e => {
          const uid = e.target.dataset.uid;
          const userRef = db.ref('usuarios/' + uid);
          userRef.once('value').then(snap => {
            const data = snap.val() || {};
            const novoStatus = !(data.banido || false);
            userRef.update({ banido: novoStatus });
          });
        };
      });

      // Evento alterar nome/foto via input
      document.querySelectorAll('.btnAlterar').forEach(btn => {
        btn.onclick = e => {
          const uid = e.target.dataset.uid;
          const tr = e.target.closest('tr');
          const novoNome = tr.querySelector('.nomeUsuarioInput').value.trim();
          const novaFoto = tr.querySelector('.fotoUsuarioInput').value.trim();

          if (novoNome === '') {
            alert('Nome não pode ser vazio');
            return;
          }

          db.ref('usuarios/' + uid).update({
            nome: novoNome,
            fotoPerfil: novaFoto
          }).then(() => {
            alert('Dados atualizados');
          });
        };
      });

      // Evento upload de foto via Storage
      document.querySelectorAll('.btnUploadFoto').forEach(btn => {
        btn.onclick = async e => {
          const uid = e.target.dataset.uid;
          const tr = e.target.closest('tr');
          const inputFile = tr.querySelector('.uploadFotoInput');
          const file = inputFile.files[0];
          if (!file) {
            alert('Selecione uma imagem para enviar');
            return;
          }

          try {
            const storageRef = storage.ref(`usuariosFotos/${uid}_${Date.now()}.jpg`);
            const snapshot = await storageRef.put(file);
            const url = await snapshot.ref.getDownloadURL();

            await db.ref(`usuarios/${uid}`).update({ fotoPerfil: url });
            alert('Foto atualizada com sucesso!');

            inputFile.value = '';
          } catch (error) {
            alert('Erro ao enviar imagem: ' + error.message);
          }
        };
      });

    });
  }

  // Carrega grupos
  function carregarGrupos() {
    db.ref('grupos').on('value', snapshot => {
      const grupos = snapshot.val() || {};
      tabelaGruposBody.innerHTML = '';
      if(Object.keys(grupos).length === 0){
        tabelaGruposBody.innerHTML = '<tr><td colspan="3">Nenhum grupo encontrado.</td></tr>';
        return;
      }

      for (const grupoId in grupos) {
        const grupo = grupos[grupoId];
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${grupoId}</td>
          <td><input type="text" value="${grupo.nome || ''}" data-id="${grupoId}" class="nomeGrupoInput" /></td>
          <td><button data-id="${grupoId}" class="btnAlterarGrupo">Alterar Nome</button></td>
        `;

        tabelaGruposBody.appendChild(tr);
      }

      // Evento alterar nome grupo
      document.querySelectorAll('.btnAlterarGrupo').forEach(btn => {
        btn.onclick = e => {
          const grupoId = e.target.dataset.id;
          const tr = e.target.closest('tr');
          const novoNome = tr.querySelector('.nomeGrupoInput').value.trim();

          if (novoNome === '') {
            alert('Nome do grupo não pode ser vazio');
            return;
          }

          db.ref('grupos/' + grupoId).update({ nome: novoNome })
            .then(() => alert('Nome do grupo atualizado'));
        };
      });

    });
  }

  // Carrega solicitações grupos
  function carregarSolicitacoes() {
    db.ref('solicitacoesGrupos').on('value', snapshot => {
      const solicitacoes = snapshot.val() || {};
      tabelaSolicitacoesBody.innerHTML = '';
      if(Object.keys(solicitacoes).length === 0){
        tabelaSolicitacoesBody.innerHTML = '<tr><td colspan="5">Nenhuma solicitação pendente.</td></tr>';
        return;
      }

      for (const id in solicitacoes) {
        const s = solicitacoes[id];
        const tr = document.createElement('tr');

        tr.innerHTML = `
          <td>${id}</td>
          <td>${s.nome}</td>
          <td>${s.uidSolicitante}</td>
          <td><button data-id="${id}" class="btnAprovar">Aprovar</button></td>
          <td><button data-id="${id}" class="btnRejeitar">Rejeitar</button></td>
        `;

        tabelaSolicitacoesBody.appendChild(tr);
      }

      // Evento aprovar
      document.querySelectorAll('.btnAprovar').forEach(btn => {
        btn.onclick = e => {
          const id = e.target.dataset.id;
          const solicitacaoRef = db.ref('solicitacoesGrupos/' + id);

          solicitacaoRef.once('value').then(snap => {
            const dados = snap.val();
            if(!dados) return alert('Solicitação não encontrada');

            // Criar novo grupo
            const novoGrupoRef = db.ref('grupos').push();
            novoGrupoRef.set({
              nome: dados.nome
            }).then(() => {
              // Remover solicitação
              solicitacaoRef.remove();
              alert('Grupo criado e solicitação removida');
            });
          });
        };
      });

      // Evento rejeitar
      document.querySelectorAll('.btnRejeitar').forEach(btn => {
        btn.onclick = e => {
          const id = e.target.dataset.id;
          db.ref('solicitacoesGrupos/' + id).remove().then(() => {
            alert('Solicitação rejeitada e removida');
          });
        };
      });

    });
  }

  // Inicializa
  carregarUsuarios();
  carregarGrupos();
  carregarSolicitacoes();

</script>

</body>
</html>
