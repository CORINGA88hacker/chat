<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat com Login Firebase + Admin</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin:0; padding:0;
    background:#f4f7f9;
    overflow-x: hidden;
  }
  #loginSection {
    max-width: 400px;
    margin: 50px auto;
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.1);
    padding: 20px;
    text-align: center;
  }
  button {
    background:#1abc9c;
    border:none;
    color:white;
    padding:10px 18px;
    border-radius:5px;
    cursor:pointer;
    font-weight:bold;
    margin-top:10px;
  }
  button:hover {background:#16a085;}
  #btnLogout {
    background: #e74c3c;
  }
  #userInfo {
    margin-top:15px;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  #userInfo img {
    width: 70px; height: 70px;
    border-radius: 50%;
    margin-right: 10px;
    object-fit: cover;
  }

  /* DIALOG - CHAT */
  dialog#chatDialog {
    width: 100vw;
    height: 100vh;
    border: none;
    padding: 0;
    margin: 0;
    position: fixed;
    top: 0; left: 0;
    background: white;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  dialog#chatDialog::backdrop {
    background: rgba(0,0,0,0.6);
  }
  dialog#chatDialog:focus-visible {
    outline: none !important;
  }
  #chatHeader {
    background: #1abc9c;
    color: white;
    padding: 12px 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }
  #nomeGrupoSelecionado {
    font-weight: bold;
    font-size: 1.2rem;
  }
  #chatHeader label {
    cursor: pointer;
    background: #16a085;
    padding: 6px 10px;
    border-radius: 5px;
    user-select: none;
    transition: background 0.3s;
    font-size: 0.9rem;
  }
  #chatHeader label:hover {
    background: #138d75;
  }
  #chatHeader input[type="file"] {
    display: none;
  }
  #btnCloseChat {
    background: transparent;
    border: none;
    font-size: 1.4rem;
    font-weight: bold;
    color: white;
    cursor: pointer;
    margin-left: 15px;
  }
  #chatMessages {
    flex: 1;
    overflow-y: auto;
    padding: 20px;
    background: #fefefe;
  }
  .msg {
    margin-bottom: 15px;
    display: flex;
    align-items: center;
  }
  .msg .fotoUser {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    margin-right: 10px;
    object-fit: cover;
    flex-shrink: 0;
  }
  .msg .msgContent {
    background: #1abc9c;
    color: white;
    padding: 10px 14px;
    border-radius: 15px;
    max-width: 70%;
    word-wrap: break-word;
  }
  .msg.me .msgContent {
    background: #16a085;
    margin-left: auto;
  }

  #inputContainer {
    display: flex;
    padding: 15px 20px;
    border-top: 1px solid #ddd;
    background: #fafafa;
  }
  #inputMsg {
    flex: 1;
    padding: 10px;
    font-size: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
    margin-right: 10px;
  }
  #btnSendMsg {
    width: 80px;
  }

  /* Pesquisa no chat */
  #searchContainer {
    padding: 10px 20px;
    background: #eee;
    border-bottom: 1px solid #ccc;
  }
  #inputSearch {
    width: 100%;
    padding: 8px 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }

</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

</head>
<body>

<!-- Login -->
<section id="loginSection">
  <h1>Entrar no Chat</h1>
  <button id="btnLoginGoogle">Entrar com Google</button>
  <button id="btnLogout" style="display:none;">Sair</button>

  <div id="userInfo" style="display:none;">
    <img id="userFoto" alt="Foto do usuário" />
    <span id="userNome"></span>
  </div>
</section>

<!-- Diálogo do Chat -->
<dialog id="chatDialog">

  <div id="chatHeader">
    <span id="nomeGrupoSelecionado">Chat Geral</span>
    <label for="inputFotoPerfil">Trocar foto</label>
    <input type="file" id="inputFotoPerfil" accept="image/*" />
    <button id="btnCloseChat" aria-label="Fechar chat">✖</button>
  </div>

  <div id="searchContainer">
    <input type="text" id="inputSearch" placeholder="Pesquisar mensagens..." />
  </div>

  <div id="chatMessages"></div>

  <div id="inputContainer">
    <input id="inputMsg" type="text" placeholder="Digite sua mensagem..." autocomplete="off"/>
    <button id="btnSendMsg">Enviar</button>
  </div>
</dialog>

<script>
  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyBHIc2E4XwRO5FXo4uHlTQVRArOis73MjE",
    authDomain: "projeto-deus-yato-928-sk.firebaseapp.com",
    databaseURL: "https://projeto-deus-yato-928-sk-default-rtdb.firebaseio.com",
    projectId: "projeto-deus-yato-928-sk",
    storageBucket: "projeto-deus-yato-928-sk.appspot.com",
    messagingSenderId: "790408726854",
    appId: "1:790408726854:android:e2f0de7b7d5dba96b0fd47"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  // Elementos
  const btnLoginGoogle = document.getElementById('btnLoginGoogle');
  const btnLogout = document.getElementById('btnLogout');
  const userInfo = document.getElementById('userInfo');
  const userFoto = document.getElementById('userFoto');
  const userNome = document.getElementById('userNome');

  const loginSection = document.getElementById('loginSection');
  const chatDialog = document.getElementById('chatDialog');
  const chatMessages = document.getElementById('chatMessages');
  const inputMsg = document.getElementById('inputMsg');
  const btnSendMsg = document.getElementById('btnSendMsg');
  const inputFotoPerfil = document.getElementById('inputFotoPerfil');
  const btnCloseChat = document.getElementById('btnCloseChat');
  const inputSearch = document.getElementById('inputSearch');

  let mensagensCache = {}; // Guarda mensagens para pesquisa

  // Login Google
  btnLoginGoogle.onclick = () => {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e => alert('Erro no login: '+e.message));
  };

  btnLogout.onclick = () => {
    auth.signOut();
  };

  btnCloseChat.onclick = () => {
    chatDialog.close();
    inputSearch.value = '';
    inputMsg.value = '';
    chatMessages.innerHTML = '';
  };

  // Ao mudar usuário logado
  auth.onAuthStateChanged(user => {
    if(user){
      loginSection.style.display = 'none';
      btnLogout.style.display = 'inline-block';
      userInfo.style.display = 'flex';

      userFoto.src = user.photoURL || 'https://via.placeholder.com/70';
      userNome.textContent = user.displayName || user.email || 'Usuário';

      // Cria no DB se não existir
      db.ref('usuarios/' + user.uid).once('value').then(snap => {
        if(!snap.exists()){
          db.ref('usuarios/' + user.uid).set({
            nome: user.displayName || '',
            email: user.email || '',
            fotoPerfil: user.photoURL || '',
            banido: false
          });
        }
      });

      // Abre o chat automaticamente
      if (!chatDialog.open) {
        chatDialog.showModal();
      }
      carregarMensagens();
    } else {
      loginSection.style.display = 'block';
      btnLogout.style.display = 'none';
      userInfo.style.display = 'none';
      if (chatDialog.open) chatDialog.close();
    }
  });

  // Enviar mensagem
  btnSendMsg.onclick = enviarMensagem;
  inputMsg.addEventListener('keydown', e => {
    if(e.key === 'Enter') enviarMensagem();
  });

  function enviarMensagem(){
    const texto = inputMsg.value.trim();
    if(texto === '') return;

    const user = auth.currentUser;
    if(!user) return alert('Faça login para enviar mensagens');

    db.ref('usuarios/' + user.uid).once('value').then(snap => {
      if(snap.exists() && snap.val().banido){
        alert('Você está banido e não pode enviar mensagens.');
        return;
      }

      // Salva mensagem no grupo geral
      const msgRef = db.ref('mensagens').push();
      msgRef.set({
        uid: user.uid,
        nome: user.displayName || '',
        fotoPerfil: user.photoURL || '',
        texto: texto,
        timestamp: Date.now()
      });
      inputMsg.value = '';
    });
  }

  // Carregar mensagens e atualizar display
  function carregarMensagens(){
    db.ref('mensagens').limitToLast(200).on('value', snapshot => {
      const msgs = snapshot.val() || {};
      mensagensCache = msgs;
      renderizarMensagens(msgs);
    });
  }

  // Renderizar mensagens (filtra por pesquisa se existir)
  function renderizarMensagens(mensagens){
    const filtro = inputSearch.value.toLowerCase().trim();
    chatMessages.innerHTML = '';
    for(const key in mensagens){
      const m = mensagens[key];
      if(filtro && !m.texto.toLowerCase().includes(filtro)) continue;

      const div = document.createElement('div');
      div.classList.add('msg');
      if(auth.currentUser && auth.currentUser.uid === m.uid) div.classList.add('me');

      div.innerHTML = `
        <img src="${m.fotoPerfil || 'https://via.placeholder.com/40'}" class="fotoUser" alt="Foto de perfil" />
        <div class="msgContent">${escapeHtml(m.texto)}</div>
      `;
      chatMessages.appendChild(div);
    }
    chatMessages.scrollTop = chatMessages.scrollHeight;
  }

  // Pesquisa mensagens em tempo real
  inputSearch.addEventListener('input', () => {
    renderizarMensagens(mensagensCache);
  });

  // Escape HTML para segurança básica
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.innerText = text;
    return div.innerHTML;
  }

  // Upload foto perfil pelo chat
  inputFotoPerfil.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const user = auth.currentUser;
      if (!user) {
        alert('Você precisa estar logado para trocar foto.');
        return;
      }

      const storageRef = storage.ref(`usuariosFotos/${user.uid}_${Date.now()}.jpg`);
      const snapshot = await storageRef.put(file);
      const urlFoto = await snapshot.ref.getDownloadURL();

      // Atualiza DB e foto do usuário no chat e login
      await db.ref(`usuarios/${user.uid}`).update({ fotoPerfil: urlFoto });
      userFoto.src = urlFoto;

      // Atualiza foto no perfil do Firebase Auth para sincronizar em mensagens futuras
      await user.updateProfile({ photoURL: urlFoto });

      alert('Foto atualizada com sucesso!');
    } catch (err) {
      alert('Erro ao enviar foto: ' + err.message);
    }
    e.target.value = '';
  });

</script>

</body>
</html>
