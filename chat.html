<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat com Login e Mensagens Alinhadas</title>

<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0; padding: 0;
    background: #f4f7f9;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #loginSection, #chatSection {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgb(0 0 0 / 0.1);
    padding: 20px;
    width: 360px;
  }
  #loginSection {
    text-align: center;
  }
  #chatSection {
    display: none;
    height: 600px;
    display: flex;
    flex-direction: column;
  }
  input[type="text"], input[type="email"], input[type="password"] {
    width: 100%;
    padding: 8px;
    margin: 6px 0 12px 0;
    box-sizing: border-box;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  button {
    background: #1abc9c;
    border: none;
    color: white;
    padding: 10px 18px;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    margin-top: 10px;
    width: 100%;
  }
  button:hover {
    background: #16a085;
  }
  #userInfo {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
  }
  #userFoto {
    width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 10px;
  }
  #chatMessages {
    flex: 1;
    border: 1px solid #ddd;
    padding: 10px;
    overflow-y: auto;
    background: #fefefe;
    border-radius: 6px;
    margin-bottom: 10px;
  }
  .msg {
    display: flex;
    margin-bottom: 12px;
    align-items: center;
  }
  /* Mensagens dos outros à esquerda */
  .msg.other {
    justify-content: flex-start;
  }
  /* Suas mensagens à direita */
  .msg.me {
    justify-content: flex-end;
  }
  .msg .userPhoto {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
  }
  /* Foto à esquerda para outros */
  .msg.other .userPhoto {
    margin-right: 8px;
  }
  /* Foto à direita para você */
  .msg.me .userPhoto {
    margin-left: 8px;
  }
  .msg .msgContent {
    max-width: 70%;
    padding: 10px 15px;
    border-radius: 20px;
    word-wrap: break-word;
  }
  /* Cor das mensagens dos outros */
  .msg.other .msgContent {
    background: #e0e0e0;
    color: #333;
  }
  /* Cor das suas mensagens */
  .msg.me .msgContent {
    background: #1abc9c;
    color: white;
  }
  #inputMsg {
    padding: 10px;
    border-radius: 6px;
    border: 1px solid #ccc;
    width: calc(100% - 100px);
    font-size: 1rem;
  }
  #btnSendMsg {
    width: 80px;
    background: #1abc9c;
    border: none;
    color: white;
    font-weight: bold;
    border-radius: 6px;
    cursor: pointer;
    margin-left: 10px;
  }
  #btnSendMsg:hover {
    background: #16a085;
  }
  #btnLogout {
    background: #e74c3c;
    margin-top: 10px;
    width: 100%;
  }
  #uploadFoto {
    margin-top: 10px;
  }
</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

</head>
<body>

<section id="loginSection">
  <h1>Login / Registro</h1>
  <input type="email" id="email" placeholder="Email" />
  <input type="password" id="password" placeholder="Senha" />
  <input type="text" id="displayName" placeholder="Nome para exibição (apenas no registro)" />
  <input type="file" id="uploadFoto" accept="image/*" />
  <button id="btnRegister">Registrar</button>
  <button id="btnLogin">Entrar</button>
</section>

<section id="chatSection">
  <div id="userInfo">
    <img id="userFoto" alt="Foto do usuário" />
    <span id="userNome"></span>
  </div>
  <div id="chatMessages"></div>
  <div style="display:flex;">
    <input id="inputMsg" type="text" placeholder="Digite sua mensagem..." autocomplete="off" />
    <button id="btnSendMsg">Enviar</button>
  </div>
  <button id="btnLogout">Sair</button>
</section>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBHIc2E4XwRO5FXo4uHlTQVRArOis73MjE",
    authDomain: "projeto-deus-yato-928-sk.firebaseapp.com",
    databaseURL: "https://projeto-deus-yato-928-sk-default-rtdb.firebaseio.com",
    projectId: "projeto-deus-yato-928-sk",
    storageBucket: "projeto-deus-yato-928-sk.appspot.com",
    messagingSenderId: "790408726854",
    appId: "1:790408726854:android:e2f0de7b7d5dba96b0fd47"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();
  const storage = firebase.storage();

  const loginSection = document.getElementById('loginSection');
  const chatSection = document.getElementById('chatSection');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const displayNameInput = document.getElementById('displayName');
  const uploadFotoInput = document.getElementById('uploadFoto');

  const userFoto = document.getElementById('userFoto');
  const userNome = document.getElementById('userNome');
  const chatMessages = document.getElementById('chatMessages');
  const inputMsg = document.getElementById('inputMsg');
  const btnSendMsg = document.getElementById('btnSendMsg');
  const btnLogout = document.getElementById('btnLogout');
  const btnLogin = document.getElementById('btnLogin');
  const btnRegister = document.getElementById('btnRegister');

  // Registrar novo usuário
  btnRegister.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();
    const displayName = displayNameInput.value.trim();

    if (!email || !password || !displayName) {
      alert('Preencha email, senha e nome para registro.');
      return;
    }

    try {
      const userCredential = await auth.createUserWithEmailAndPassword(email, password);
      const user = userCredential.user;

      // Fazer upload da foto se existir
      let fotoURL = '';
      if (uploadFotoInput.files[0]) {
        const file = uploadFotoInput.files[0];
        const storageRef = storage.ref(`usuariosFotos/${user.uid}_${Date.now()}.jpg`);
        await storageRef.put(file);
        fotoURL = await storageRef.getDownloadURL();
      }

      // Atualizar perfil do usuário
      await user.updateProfile({
        displayName: displayName,
        photoURL: fotoURL || ''
      });

      // Salvar no banco
      await db.ref('usuarios/' + user.uid).set({
        nome: displayName,
        fotoPerfil: fotoURL || '',
        email: user.email,
        banido: false
      });

      alert('Registro realizado com sucesso!');
      limparCamposLogin();
    } catch (error) {
      alert('Erro no registro: ' + error.message);
    }
  };

  // Login usuário
  btnLogin.onclick = async () => {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
      alert('Preencha email e senha.');
      return;
    }

    try {
      await auth.signInWithEmailAndPassword(email, password);
      limparCamposLogin();
    } catch (error) {
      alert('Erro no login: ' + error.message);
    }
  };

  // Logout
  btnLogout.onclick = () => {
    auth.signOut();
  };

  // Limpa campos login/registro
  function limparCamposLogin(){
    emailInput.value = '';
    passwordInput.value = '';
    displayNameInput.value = '';
    uploadFotoInput.value = '';
  }

  // Ao mudar estado de autenticação
  auth.onAuthStateChanged(user => {
    if (user) {
      // Se banido, desloga
      db.ref('usuarios/' + user.uid).once('value').then(snap => {
        const userData = snap.val();
        if (userData && userData.banido) {
          alert('Você está banido e não pode acessar o chat.');
          auth.signOut();
          return;
        }
        mostrarChat(user);
      });
    } else {
      mostrarLogin();
    }
  });

  // Mostrar chat
  function mostrarChat(user) {
    loginSection.style.display = 'none';
    chatSection.style.display = 'flex';

    userFoto.src = user.photoURL || 'https://via.placeholder.com/50';
    userNome.textContent = user.displayName || user.email;

    carregarMensagens();
  }

  // Mostrar login
  function mostrarLogin() {
    loginSection.style.display = 'block';
    chatSection.style.display = 'none';
    chatMessages.innerHTML = '';
  }

  // Enviar mensagem
  btnSendMsg.onclick = enviarMensagem;
  inputMsg.addEventListener('keydown', e => {
    if (e.key === 'Enter') enviarMensagem();
  });

  async function enviarMensagem(){
    const texto = inputMsg.value.trim();
    if (!texto) return;

    const user = auth.currentUser;
    if (!user) {
      alert('Faça login para enviar mensagens');
      return;
    }

    // Verifica se banido
    const snap = await db.ref('usuarios/' + user.uid).once('value');
    if (snap.exists() && snap.val().banido) {
      alert('Você está banido e não pode enviar mensagens.');
      return;
    }

    const msgRef = db.ref('mensagens').push();
    await msgRef.set({
      uid: user.uid,
      nome: user.displayName || '',
      fotoPerfil: user.photoURL || '',
      texto: texto,
      timestamp: Date.now()
    });

    inputMsg.value = '';
  }

  // Carregar mensagens
  function carregarMensagens(){
    db.ref('mensagens').limitToLast(50).on('value', snapshot => {
      const msgs = snapshot.val() || {};
      chatMessages.innerHTML = '';
      for (const key in msgs) {
        const m = msgs[key];
        const div = document.createElement('div');
        // Define classe pra alinhamento
        div.classList.add('msg');
        if (auth.currentUser && auth.currentUser.uid === m.uid) {
          div.classList.add('me');
        } else {
          div.classList.add('other');
        }

        const foto = m.fotoPerfil || 'https://via.placeholder.com/40';
        if (div.classList.contains('me')) {
          div.innerHTML = `<div class="msgContent">${escapeHtml(m.texto)}</div><img src="${foto}" alt="Foto" class="userPhoto" />`;
        } else {
          div.innerHTML = `<img src="${foto}" alt="Foto" class="userPhoto" /><div class="msgContent">${escapeHtml(m.texto)}</div>`;
        }

        chatMessages.appendChild(div);
      }
      chatMessages.scrollTop = chatMessages.scrollHeight;
    });
  }

  // Escape HTML básico
  function escapeHtml(text) {
    const div = document.createElement('div');
    div.innerText = text;
    return div.innerHTML;
  }
</script>

</body>
</html>
