<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat Manual Firebase + Privacidade</title>

<style>
  body { font-family: Arial,sans-serif; margin:0; padding:0; background:#f0f0f0; }
  #loginForm, #chatApp, #adminPanel { max-width: 600px; margin: 20px auto; background: white; padding: 20px; border-radius: 8px; }
  #chatApp, #adminPanel { display:none; }
  input, button { padding:10px; margin:5px 0; width: 100%; box-sizing: border-box; }
  button { background:#1abc9c; color:white; border:none; cursor:pointer; border-radius:5px; }
  button:hover { background:#16a085; }
  #mensagens { height:300px; overflow-y:auto; border:1px solid #ccc; padding:10px; background:#fafafa; margin-bottom:10px; }
  .msg { margin-bottom:10px; }
  .msg.me { text-align:right; }
  .msg .nome { font-weight:bold; }
  .user-list, .group-list { max-height: 200px; overflow-y: auto; border: 1px solid #ccc; margin-bottom: 10px; }
  .user-list div, .group-list div { padding: 5px; cursor: pointer; border-bottom: 1px solid #ddd; }
  .user-list div:hover, .group-list div:hover { background: #1abc9c; color: white; }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<div id="loginForm">
  <h2>Cadastro / Login</h2>
  <input type="email" id="email" placeholder="Seu email edu.mt.gov.br" />
  <input type="password" id="senha" placeholder="Senha" />
  <input type="text" id="nome" placeholder="Seu nome" />
  <input type="text" id="fotoPerfil" placeholder="URL da foto de perfil (opcional)" />
  <button id="btnCadastrar">Cadastrar</button>
  <button id="btnLogin">Entrar</button>
  <p id="msgErro" style="color:red;"></p>
</div>

<div id="chatApp">
  <h2>Chat</h2>
  <button id="btnLogout">Sair</button>

  <h3>Usuários disponíveis</h3>
  <div class="user-list" id="listaUsuarios"></div>

  <h3>Grupos disponíveis</h3>
  <div class="group-list" id="listaGrupos"></div>

  <h3>Conversa: <span id="nomeConversa">Nenhuma</span></h3>
  <div id="mensagens"></div>
  <input type="text" id="inputMsg" placeholder="Digite sua mensagem..." />
  <button id="btnEnviarMsg">Enviar</button>
</div>

<div id="adminPanel" style="max-width:600px; margin: 20px auto;">
  <h2>Admin (sem login)</h2>
  <button id="btnAtualizarUsuarios">Atualizar usuários</button>
  <button id="btnAtualizarGrupos">Atualizar grupos</button>
  <div id="adminUsuarios"></div>
  <div id="adminGrupos"></div>
</div>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyBHIc2E4XwRO5FXo4uHlTQVRArOis73MjE",
    authDomain: "projeto-deus-yato-928-sk.firebaseapp.com",
    databaseURL: "https://projeto-deus-yato-928-sk-default-rtdb.firebaseio.com",
    projectId: "projeto-deus-yato-928-sk",
    storageBucket: "projeto-deus-yato-928-sk.appspot.com",
    messagingSenderId: "790408726854",
    appId: "1:790408726854:android:e2f0de7b7d5dba96b0fd47"
  };

  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  // Elementos DOM
  const loginForm = document.getElementById('loginForm');
  const chatApp = document.getElementById('chatApp');
  const adminPanel = document.getElementById('adminPanel');
  const emailInput = document.getElementById('email');
  const senhaInput = document.getElementById('senha');
  const nomeInput = document.getElementById('nome');
  const fotoPerfilInput = document.getElementById('fotoPerfil');
  const btnCadastrar = document.getElementById('btnCadastrar');
  const btnLogin = document.getElementById('btnLogin');
  const msgErro = document.getElementById('msgErro');

  const listaUsuariosDiv = document.getElementById('listaUsuarios');
  const listaGruposDiv = document.getElementById('listaGrupos');
  const nomeConversaSpan = document.getElementById('nomeConversa');
  const mensagensDiv = document.getElementById('mensagens');
  const inputMsg = document.getElementById('inputMsg');
  const btnEnviarMsg = document.getElementById('btnEnviarMsg');
  const btnLogout = document.getElementById('btnLogout');

  let usuarioAtual = null;
  let chatAtual = null; // pode ser {tipo:'privado', id:'uid1_uid2'} ou {tipo:'grupo', id:'grupoId'}

  // Validação de email edu.mt.gov.br
  function validarEmailEdu(email){
    return /^.+@edu\.mt\.gov\.br$/.test(email);
  }

  // Criar usuário manual
  btnCadastrar.onclick = () => {
    const email = emailInput.value.trim();
    const senha = senhaInput.value.trim();
    const nome = nomeInput.value.trim();
    const fotoPerfil = fotoPerfilInput.value.trim() || 'https://i.pravatar.cc/150?img=5';

    msgErro.textContent = '';

    if(!validarEmailEdu(email)){
      msgErro.textContent = 'Use um email edu.mt.gov.br válido';
      return;
    }
    if(senha.length < 6){
      msgErro.textContent = 'Senha deve ter ao menos 6 caracteres';
      return;
    }
    if(nome.length < 2){
      msgErro.textContent = 'Informe seu nome';
      return;
    }

    auth.createUserWithEmailAndPassword(email, senha)
      .then(cred => {
        // Salvar dados do usuário no db
        usuarioAtual = {
          uid: cred.user.uid,
          nome,
          fotoPerfil
        };
        db.ref('usuarios/' + usuarioAtual.uid).set(usuarioAtual);
      })
      .catch(err => {
        msgErro.textContent = err.message;
      });
  };

  // Login
  btnLogin.onclick = () => {
    const email = emailInput.value.trim();
    const senha = senhaInput.value.trim();
    msgErro.textContent = '';
    if(!validarEmailEdu(email)){
      msgErro.textContent = 'Use um email edu.mt.gov.br válido';
      return;
    }
    if(senha.length < 6){
      msgErro.textContent = 'Senha inválida';
      return;
    }

    auth.signInWithEmailAndPassword(email, senha)
      .catch(err => {
        msgErro.textContent = err.message;
      });
  };

  // Logout
  btnLogout.onclick = () => {
    auth.signOut();
  };

  // Atualiza interface quando o usuário loga ou desloga
  auth.onAuthStateChanged(user => {
    if(user){
      // Carregar dados do usuário no db
      db.ref('usuarios/' + user.uid).once('value').then(snap => {
        usuarioAtual = snap.val();
        if(!usuarioAtual){
          // Caso usuário não exista no db, criar com dados padrão
          usuarioAtual = {
            uid: user.uid,
            nome: user.email.split('@')[0],
            fotoPerfil: 'https://i.pravatar.cc/150?img=5'
          };
          db.ref('usuarios/' + user.uid).set(usuarioAtual);
        }
        loginForm.style.display = 'none';
        chatApp.style.display = 'block';
        adminPanel.style.display = 'block'; // Mostrar admin sem login por enquanto

        carregarUsuarios();
        carregarGrupos();
        limparChat();
      });
    } else {
      usuarioAtual = null;
      loginForm.style.display = 'block';
      chatApp.style.display = 'none';
      adminPanel.style.display = 'none';
    }
  });

  // Carregar lista de usuários (exceto o atual)
  function carregarUsuarios(){
    db.ref('usuarios').on('value', snap => {
      const usuarios = snap.val() || {};
      listaUsuariosDiv.innerHTML = '';
      Object.keys(usuarios).forEach(uid => {
        if(uid === usuarioAtual.uid) return; // pula o atual
        const u = usuarios[uid];
        const div = document.createElement('div');
        div.textContent = u.nome;
        div.style.display = 'flex';
        div.style.alignItems = 'center';
        div.style.gap = '10px';

        const img = document.createElement('img');
        img.src = u.fotoPerfil || 'https://i.pravatar.cc/150?img=5';
        img.style.width = '30px';
        img.style.height = '30px';
        img.style.borderRadius = '50%';

        div.prepend(img);
        div.onclick = () => abrirChatPrivado(uid, u.nome);
        listaUsuariosDiv.appendChild(div);
      });
    });
  }

  // Carregar grupos que o usuário participa
  function carregarGrupos(){
    db.ref('grupos').on('value', snap => {
      const grupos = snap.val() || {};
      listaGruposDiv.innerHTML = '';
      Object.keys(grupos).forEach(grupoId => {
        const g = grupos[grupoId];
        // Só mostra grupos onde o usuário é membro
        if(g.membros && g.membros[usuarioAtual.uid]){
          const div = document.createElement('div');
          div.textContent = g.nome;
          div.style.cursor = 'pointer';
          div.onclick = () => abrirChatGrupo(grupoId, g.nome);
          listaGruposDiv.appendChild(div);
        }
      });
    });
  }

  // Abrir chat privado
  function abrirChatPrivado(uidOutro, nomeOutro){
    chatAtual = { tipo: 'privado', id: gerarIdChatPrivado(usuarioAtual.uid, uidOutro) };
    nomeConversaSpan.textContent = 'Chat com ' + nomeOutro;
    carregarMensagens();
  }

  // Abrir chat grupo
  function abrirChatGrupo(grupoId, nomeGrupo){
    chatAtual = { tipo: 'grupo', id: grupoId };
    nomeConversaSpan.textContent = 'Grupo: ' + nomeGrupo;
    carregarMensagens();
  }

  // Gerar id único do chat privado entre dois usuários
  function gerarIdChatPrivado(uid1, uid2){
    return [uid1, uid2].sort().join('_');
  }

  let mensagensListener = null;

  // Carregar mensagens do chat atual
  function carregarMensagens(){
    if(mensagensListener) mensagensListener.off();

    mensagensDiv.innerHTML = 'Carregando mensagens...';

    let ref;
    if(chatAtual.tipo === 'privado'){
      ref = db.ref('chatsPrivados/' + chatAtual.id + '/mensagens');
    } else {
      ref = db.ref('grupos/' + chatAtual.id + '/mensagens');
    }

    mensagensListener = ref;
    ref.off();
    ref.on('value', snap => {
      const msgs = snap.val() || {};
      mensagensDiv.innerHTML = '';

      // Carregar usuários para mostrar nome e foto
      db.ref('usuarios').once('value').then(userSnap => {
        const users = userSnap.val() || {};
        for(const key in msgs){
          const m = msgs[key];
          const usuario = users[m.uid] || {};
          const div = document.createElement('div');
          div.className = 'msg ' + (m.uid === usuarioAtual.uid ? 'me' : '');
          div.innerHTML = `<span class="nome">${usuario.nome || 'Usuário'}</span><br>${m.texto}`;
          mensagensDiv.appendChild(div);
        }
        mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
      });
    });
  }

  // Enviar mensagem
  btnEnviarMsg.onclick = () => {
    const texto = inputMsg.value.trim();
    if(!texto) return;
    if(!chatAtual) return alert('Selecione um chat');

    let ref;
    if(chatAtual.tipo === 'privado'){
      ref = db.ref('chatsPrivados/' + chatAtual.id + '/mensagens');
    } else {
      ref = db.ref('grupos/' + chatAtual.id + '/mensagens');
    }

    const msg = {
      uid: usuarioAtual.uid,
      texto,
      timestamp: Date.now()
    };

    ref.push(msg).then(() => {
      inputMsg.value = '';
      carregarMensagens();
    });
  };

  // Limpar chat
  function limparChat(){
    mensagensDiv.innerHTML = '';
    nomeConversaSpan.textContent = 'Nenhuma';
    chatAtual = null;
  }

  // Admin básico só para atualizar usuários e grupos (sem login)
  const btnAtualizarUsuarios = document.getElementById('btnAtualizarUsuarios');
  const btnAtualizarGrupos = document.getElementById('btnAtualizarGrupos');
  const adminUsuarios = document.getElementById('adminUsuarios');
  const adminGrupos = document.getElementById('adminGrupos');

  btnAtualizarUsuarios.onclick = () => {
    db.ref('usuarios').once('value').then(snap => {
      const users = snap.val() || {};
      adminUsuarios.innerHTML = '<h3>Usuários</h3>';
      for(const uid in users){
        const u = users[uid];
        const banido = u.banido || false;
        adminUsuarios.innerHTML += `
          <div>
            <img src="${u.fotoPerfil || 'https://i.pravatar.cc/150?img=5'}" width="30" height="30" style="border-radius:50%; vertical-align:middle;" />
            <b>${u.nome || uid}</b> - Banido: ${banido}
            <button onclick="banirUsuario('${uid}', ${!banido})">${banido ? 'Desbanir' : 'Banir'}</button>
          </div>
        `;
      }
    });
  };

  btnAtualizarGrupos.onclick = () => {
    db.ref('grupos').once('value').then(snap => {
      const grupos = snap.val() || {};
      adminGrupos.innerHTML = '<h3>Grupos</h3>';
      for(const gid in grupos){
        const g = grupos[gid];
        adminGrupos.innerHTML += `
          <div>
            <b>${g.nome || gid}</b> - Membros: ${g.membros ? Object.keys(g.membros).length : 0}
          </div>
        `;
      }
    });
  };

  window.banirUsuario = function(uid, banir){
    db.ref('usuarios/' + uid).update({ banido: banir });
    alert(banir ? 'Usuário banido' : 'Usuário desbanido');
    btnAtualizarUsuarios.click();
  };

</script>

</body>
</html>
