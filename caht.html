<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chat Grupos + Privado Firebase com Registro e Pesquisa</title>

<style>
  html, body {
    margin: 0; height: 100%;
    font-family: Arial, sans-serif;
    background: #f0f0f0;
  }
  #app {
    display: flex;
    height: 100vh;
    width: 100vw;
  }
  #menuLateral {
    width: 300px;
    background: #2c3e50;
    color: white;
    display: flex;
    flex-direction: column;
    padding: 10px;
    box-sizing: border-box;
  }
  .abaMenu {
    display: flex;
    justify-content: space-around;
    margin-bottom: 10px;
  }
  .abaMenu button {
    background: #34495e;
    border: none;
    color: white;
    padding: 8px 15px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    flex-grow: 1;
    margin: 0 4px;
    transition: background 0.3s;
  }
  .abaMenu button.ativo {
    background: #1abc9c;
  }
  #inputPesquisa {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 6px;
    border: none;
    font-size: 16px;
    width: 100%;
    box-sizing: border-box;
  }
  #listaGrupos, #listaUsuarios {
    flex-grow: 1;
    overflow-y: auto;
  }
  .itemLista {
    padding: 10px;
    border-radius: 6px;
    margin-bottom: 6px;
    cursor: pointer;
    background: #34495e;
    display: flex;
    align-items: center;
    transition: background 0.3s;
  }
  .itemLista:hover, .itemLista.selecionado {
    background: #1abc9c;
  }
  .itemLista img {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
    object-fit: cover;
  }

  #areaChat {
    flex-grow: 1;
    background: white;
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  #headerChat {
    background: #1abc9c;
    color: white;
    padding: 15px;
    font-size: 18px;
    border-bottom: 2px solid #16a085;
  }
  #mensagens {
    flex-grow: 1;
    overflow-y: auto;
    padding: 15px;
    box-sizing: border-box;
    display: flex;
    flex-direction: column;
  }
  .mensagem {
    margin-bottom: 12px;
    display: flex;
    gap: 10px;
    align-items: flex-start;
    max-width: 70%;
    word-break: break-word;
  }
  .mensagem.minha {
    margin-left: auto;
    flex-direction: row-reverse;
  }
  .mensagem.minha .conteudo {
    background: #1abc9c;
    color: white;
  }
  .mensagem .fotoUsuario {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    object-fit: cover;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }
  .mensagem .conteudo {
    background: #ecf0f1;
    border-radius: 10px;
    padding: 8px 12px;
    max-width: 70%;
  }
  .mensagem .nome {
    font-weight: bold;
    margin-bottom: 4px;
    font-size: 14px;
  }
  #inputArea {
    display: flex;
    padding: 10px;
    border-top: 1px solid #ddd;
  }
  #inputMsg {
    flex-grow: 1;
    padding: 10px;
    font-size: 16px;
    border-radius: 20px;
    border: 1px solid #ccc;
    outline: none;
  }
  #btnEnviar {
    margin-left: 10px;
    background: #1abc9c;
    border: none;
    color: white;
    padding: 0 20px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: bold;
    transition: background 0.3s;
  }
  #btnEnviar:hover {
    background: #16a085;
  }

  /* Tela cadastro */
  #telaCadastro {
    position: fixed;
    top:0; left:0; right:0; bottom:0;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #telaCadastro .box {
    background: white;
    padding: 30px;
    border-radius: 10px;
    width: 300px;
    box-sizing: border-box;
    text-align: center;
  }
  #telaCadastro input {
    width: 100%;
    padding: 10px;
    margin: 10px 0;
    font-size: 16px;
    border-radius: 6px;
    border: 1px solid #ccc;
    box-sizing: border-box;
  }
  #telaCadastro button {
    background: #1abc9c;
    border: none;
    color: white;
    font-weight: bold;
    padding: 10px 20px;
    border-radius: 20px;
    cursor: pointer;
    transition: background 0.3s;
    width: 100%;
    font-size: 16px;
  }
  #telaCadastro button:hover {
    background: #16a085;
  }
  #telaCadastro h2 {
    margin-bottom: 15px;
  }
</style>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

</head>
<body>

<!-- Tela cadastro -->
<div id="telaCadastro">
  <div class="box">
    <h2>Crie sua conta</h2>
    <input type="text" id="nomeCadastro" placeholder="Seu nome" />
    <input type="url" id="fotoCadastro" placeholder="URL da sua foto de perfil" />
    <button id="btnCriarConta">Criar Conta</button>
  </div>
</div>

<div id="app" style="display:none;">
  <div id="menuLateral">
    <div class="abaMenu">
      <button id="btnAbaGrupos" class="ativo">Grupos</button>
      <button id="btnAbaUsuarios">Usuários</button>
    </div>
    <input type="text" id="inputPesquisa" placeholder="Pesquisar..." />
    <div id="listaGrupos"></div>
    <div id="listaUsuarios" style="display:none"></div>
  </div>

  <div id="areaChat">
    <div id="headerChat">Selecione um grupo ou usuário para conversar</div>
    <div id="mensagens"></div>
    <div id="inputArea">
      <input type="text" id="inputMsg" placeholder="Digite sua mensagem..." disabled />
      <button id="btnEnviar" disabled>Enviar</button>
    </div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyBHIc2E4XwRO5FXo4uHlTQVRArOis73MjE",
  authDomain: "projeto-deus-yato-928-sk.firebaseapp.com",
  databaseURL: "https://projeto-deus-yato-928-sk-default-rtdb.firebaseio.com",
  projectId: "projeto-deus-yato-928-sk",
  storageBucket: "projeto-deus-yato-928-sk.appspot.com",
  messagingSenderId: "790408726854",
  appId: "1:790408726854:android:e2f0de7b7d5dba96b0fd47"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let usuarioAtual = null; // Vai receber dados do usuário logado

// Elementos DOM
const telaCadastro = document.getElementById('telaCadastro');
const btnCriarConta = document.getElementById('btnCriarConta');
const nomeCadastro = document.getElementById('nomeCadastro');
const fotoCadastro = document.getElementById('fotoCadastro');

const app = document.getElementById('app');
const btnAbaGrupos = document.getElementById('btnAbaGrupos');
const btnAbaUsuarios = document.getElementById('btnAbaUsuarios');
const listaGrupos = document.getElementById('listaGrupos');
const listaUsuarios = document.getElementById('listaUsuarios');
const headerChat = document.getElementById('headerChat');
const mensagensDiv = document.getElementById('mensagens');
const inputMsg = document.getElementById('inputMsg');
const btnEnviar = document.getElementById('btnEnviar');
const inputPesquisa = document.getElementById('inputPesquisa');

let abaAtual = 'grupos';
let grupoSelecionado = null;
let usuarioSelecionado = null;
let mensagensListener = null;
let gruposDados = {};
let usuariosDados = {};

// Função para salvar usuário novo
btnCriarConta.onclick = () => {
  const nome = nomeCadastro.value.trim();
  const foto = fotoCadastro.value.trim();

  if (!nome) {
    alert('Por favor, digite seu nome');
    return;
  }
  if (!foto) {
    alert('Por favor, coloque a URL da sua foto de perfil');
    return;
  }

  // Gerar UID simples e único (pode melhorar depois)
  const novoUid = 'user_' + Date.now();

  const novoUsuario = {
    nome,
    fotoPerfil: foto,
  };

  db.ref('usuarios/' + novoUid).set(novoUsuario).then(() => {
    usuarioAtual = { uid: novoUid, ...novoUsuario };
    telaCadastro.style.display = 'none';
    app.style.display = 'flex';
    inicializarApp();
  }).catch(err => {
    alert('Erro ao criar conta: ' + err.message);
  });
};

// Inicializa app após login
function inicializarApp() {
  carregarUsuarios();
  carregarGrupos();

  btnAbaGrupos.onclick = () => {
    abaAtual = 'grupos';
    btnAbaGrupos.classList.add('ativo');
    btnAbaUsuarios.classList.remove('ativo');
    listaGrupos.style.display = 'block';
    listaUsuarios.style.display = 'none';
    limparChat();
    carregarGrupos();
    inputPesquisa.value = '';
  };
  btnAbaUsuarios.onclick = () => {
    abaAtual = 'usuarios';
    btnAbaUsuarios.classList.add('ativo');
    btnAbaGrupos.classList.remove('ativo');
    listaUsuarios.style.display = 'block';
    listaGrupos.style.display = 'none';
    limparChat();
    carregarUsuarios();
    inputPesquisa.value = '';
  };

  inputPesquisa.oninput = () => {
    if (abaAtual === 'grupos') {
      filtrarLista(listaGrupos, inputPesquisa.value);
    } else {
      filtrarLista(listaUsuarios, inputPesquisa.value);
    }
  };

  btnEnviar.onclick = () => {
    const texto = inputMsg.value.trim();
    if (!texto) return;

    let ref;
    if (grupoSelecionado) {
      ref = db.ref('mensagens/' + grupoSelecionado);
    } else if (usuarioSelecionado) {
      const chatId = gerarIdChatPrivado(usuarioAtual.uid, usuarioSelecionado);
      ref = db.ref('chatPrivado/' + chatId);
    } else {
      return;
    }

    const msg = {
      uid: usuarioAtual.uid,
      texto,
      timestamp: Date.now()
    };

    ref.push(msg).then(() => {
      inputMsg.value = '';
      inputMsg.focus();
    });
  };

  // Já inicia na aba grupos
  btnAbaGrupos.click();
}

function limparChat() {
  grupoSelecionado = null;
  usuarioSelecionado = null;
  headerChat.textContent = 'Selecione um grupo ou usuário para conversar';
  mensagensDiv.innerHTML = '';
  inputMsg.value = '';
  inputMsg.disabled = true;
  btnEnviar.disabled = true;
}

function carregarGrupos() {
  listaGrupos.innerHTML = 'Carregando grupos...';
  const gruposRef = db.ref('grupos');
  gruposRef.on('value', snapshot => {
    gruposDados = snapshot.val() || {};
    listaGrupos.innerHTML = '';
    for (const grupoId in gruposDados) {
      const grupo = gruposDados[grupoId];
      const div = document.createElement('div');
      div.className = 'itemLista';
      div.dataset.id = grupoId;
      div.innerHTML = `
        <img src="${grupo.foto || 'https://via.placeholder.com/40'}" alt="foto grupo"/>
        <span>${grupo.nome || grupoId}</span>
      `;
      div.onclick = () => selecionarGrupo(grupoId);
      listaGrupos.appendChild(div);
    }
    filtrarLista(listaGrupos, inputPesquisa.value);
  });
}

function carregarUsuarios() {
  listaUsuarios.innerHTML = 'Carregando usuários...';
  const usuariosRef = db.ref('usuarios');
  usuariosRef.on('value', snapshot => {
    usuariosDados = snapshot.val() || {};
    listaUsuarios.innerHTML = '';
    for (const uid in usuariosDados) {
      if (uid === usuarioAtual.uid) continue;
      const user = usuariosDados[uid];
      const div = document.createElement('div');
      div.className = 'itemLista';
      div.dataset.id = uid;
      div.innerHTML = `
        <img src="${user.fotoPerfil || 'https://via.placeholder.com/40'}" alt="foto usuario" />
        <span>${user.nome || uid}</span>
      `;
      div.onclick = () => selecionarUsuario(uid);
      listaUsuarios.appendChild(div);
    }
    filtrarLista(listaUsuarios, inputPesquisa.value);
  });
}

function selecionarGrupo(grupoId) {
  grupoSelecionado = grupoId;
  usuarioSelecionado = null;
  headerChat.textContent = gruposDados[grupoId].nome || grupoId;

  marcarSelecionado(listaGrupos, grupoId);

  inputMsg.disabled = false;
  btnEnviar.disabled = false;
  inputMsg.value = '';
  inputMsg.focus();

  carregarMensagensGrupo(grupoId);
}

function selecionarUsuario(uid) {
  usuarioSelecionado = uid;
  grupoSelecionado = null;
  const user = usuariosDados[uid];
  headerChat.textContent = `Chat privado com ${user.nome || uid}`;

  marcarSelecionado(listaUsuarios, uid);

  inputMsg.disabled = false;
  btnEnviar.disabled = false;
  inputMsg.value = '';
  inputMsg.focus();

  carregarMensagensPrivadas(uid);
}

function marcarSelecionado(lista, id) {
  Array.from(lista.children).forEach(div => {
    div.classList.toggle('selecionado', div.dataset.id === id);
  });
}

function gerarIdChatPrivado(uid1, uid2) {
  return [uid1, uid2].sort().join('_');
}

function carregarMensagensGrupo(grupoId) {
  if (mensagensListener) {
    mensagensListener.off();
  }
  mensagensDiv.innerHTML = 'Carregando mensagens...';

  const ref = db.ref('mensagens/' + grupoId);
  mensagensListener = ref;

  ref.on('value', snapshot => {
    const msgs = snapshot.val() || {};
    mensagensDiv.innerHTML = '';

    for (const key in msgs) {
      const msg = msgs[key];
      const user = usuariosDados[msg.uid] || {};
      adicionarMensagemNaTela(user.nome || 'Usuário', user.fotoPerfil || 'https://via.placeholder.com/40', msg.texto, msg.uid);
    }
    mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
  });
}

function carregarMensagensPrivadas(uidOutro) {
  if (mensagensListener) {
    mensagensListener.off();
  }
  mensagensDiv.innerHTML = 'Carregando mensagens privadas...';

  const chatId = gerarIdChatPrivado(usuarioAtual.uid, uidOutro);
  const ref = db.ref('chatPrivado/' + chatId);
  mensagensListener = ref;

  ref.on('value', snapshot => {
    const msgs = snapshot.val() || {};
    mensagensDiv.innerHTML = '';

    for (const key in msgs) {
      const msg = msgs[key];
      const user = usuariosDados[msg.uid] || {};
      adicionarMensagemNaTela(user.nome || 'Usuário', user.fotoPerfil || 'https://via.placeholder.com/40', msg.texto, msg.uid);
    }
    mensagensDiv.scrollTop = mensagensDiv.scrollHeight;
  });
}

function adicionarMensagemNaTela(nome, foto, texto, uidMensagem) {
  const div = document.createElement('div');
  div.className = 'mensagem';
  if (uidMensagem === usuarioAtual.uid) {
    div.classList.add('minha');
  }

  div.innerHTML = `
    <img src="${foto}" alt="${nome}" class="fotoUsuario" />
    <div class="conteudo">
      <div class="nome">${nome}</div>
      <div class="texto">${texto}</div>
    </div>
  `;
  mensagensDiv.appendChild(div);
}

// Função para filtrar itens da lista (grupos ou usuários)
function filtrarLista(lista, textoFiltro) {
  textoFiltro = textoFiltro.toLowerCase();
  Array.from(lista.children).forEach(div => {
    const nome = div.textContent.toLowerCase();
    div.style.display = nome.includes(textoFiltro) ? '' : 'none';
  });
}

// Inicialização
// Checa se usuário já está salvo no localStorage
const userSalvo = localStorage.getItem('usuarioAtual');
if
